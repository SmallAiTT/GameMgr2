var http = require("http");
var ctrlConst = require("../cfg/ctrlConst");
var ctrlUrl = ctrlConst.game;
var ttUtils = require("tt-utils").ttUtils;

function fmtArgs(body, keys){
    var str = "?";
    for(var i = 0, li = keys.length; i < li; ++i){
        var key = keys[i];
        str += key + "=" + (body[key] || "");
        if(i < li - 1) str += "&";
    }
    return str;
}

module.exports = function(app){
    console.log(ctrlUrl.play)
    app.post(ctrlUrl.play, function(req, res){
        console.log(req.body);
        var body = req.body;
        var gameUrl = body.gameUrl;
        var validUrl = body.validUrl;

        var p = validUrl + fmtArgs(body, ["userId", "cpId", "cpServiceId", "channelId", "key"]);
        var request = http.request(p, function(response){
            response.on('data',function (chunk) {
                if(chunk == "0"){
                    var str = gameUrl + fmtArgs(body, ["userId", "cpId", "cpServiceId", "channelId", "key"])
                    res.redirect(str);
                }else{
                    res.redirect("http://www.baidu.com");
                }
            });
            response.on("end", function(error){
                console.log(error)
            })
        })

        ttUtils.tryIt(request.end.bind(request), [request], function(err){
            console.log(err);
            res.end("SDF");
        });
    });

};